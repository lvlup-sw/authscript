using Gateway.API.Contracts;
using Gateway.API.GraphQL.Inputs;
using Gateway.API.GraphQL.Models;
using Gateway.API.Services;
using Microsoft.Extensions.Logging;

namespace Gateway.API.GraphQL.Mutations;

public sealed class Mutation
{
    public async Task<PARequestModel> CreatePARequest(
        CreatePARequestInput input,
        [Service] IPARequestStore store,
        [Service] ReferenceDataService refData,
        CancellationToken ct)
    {
        var proc = refData.FindProcedureByCode(input.ProcedureCode);
        var med = refData.FindMedicationByCode(input.ProcedureCode);
        var procedureName = proc?.Name ?? med?.Name ?? throw new ArgumentException($"Procedure/medication {input.ProcedureCode} not found");
        var provider = refData.FindProviderById(input.ProviderId ?? "DR001") ?? refData.Providers[0];

        var patient = new PatientModel
        {
            Id = input.Patient.Id,
            Name = input.Patient.Name,
            Mrn = input.Patient.Mrn,
            Dob = input.Patient.Dob,
            MemberId = input.Patient.MemberId,
            Payer = input.Patient.Payer,
            Address = input.Patient.Address,
            Phone = input.Patient.Phone,
        };

        var now = DateTimeOffset.UtcNow.ToString("o");
        var request = new PARequestModel
        {
            Id = "", // will be generated by store
            PatientId = input.Patient.PatientId,
            Patient = patient,
            ProcedureCode = input.ProcedureCode,
            ProcedureName = procedureName,
            Diagnosis = input.DiagnosisName ?? "Pending",
            DiagnosisCode = input.DiagnosisCode ?? "PENDING",
            Payer = input.Patient.Payer,
            ProviderId = provider.Id,
            Provider = provider.Name,
            ProviderNpi = provider.Npi,
            ServiceDate = DateTimeOffset.UtcNow.ToString("MMMM d, yyyy"),
            PlaceOfService = "Outpatient",
            ClinicalSummary = "",
            Status = "draft",
            Confidence = 0,
            CreatedAt = now,
            UpdatedAt = now,
            Criteria = [],
        };

        var fhirPatientId = input.Patient.FhirId ?? input.Patient.PatientId;
        return await store.CreateAsync(request, fhirPatientId, ct);
    }

    public async Task<PARequestModel?> UpdatePARequest(
        UpdatePARequestInput input,
        [Service] IPARequestStore store,
        CancellationToken ct)
    {
        var criteria = input.Criteria?.Select(c => new CriterionModel { Met = c.Met, Label = c.Label, Reason = c.Reason }).ToList();
        return await store.UpdateFieldsAsync(
            input.Id, input.Diagnosis, input.DiagnosisCode,
            input.ServiceDate, input.PlaceOfService, input.ClinicalSummary,
            criteria, ct);
    }

    public async Task<PARequestModel?> ProcessPARequest(
        string id,
        [Service] IPARequestStore store,
        [Service] IFhirDataAggregator fhirAggregator,
        [Service] IIntelligenceClient intelligenceClient,
        [Service] ILogger<Mutation> logger,
        CancellationToken ct)
    {
        var paRequest = await store.GetByIdAsync(id, ct);
        if (paRequest is null) return null;

        // Use FHIR patient ID for real clinical data
        var fhirPatientId = paRequest.FhirPatientId ?? paRequest.PatientId;

        try
        {
            var clinicalBundle = await fhirAggregator.AggregateClinicalDataAsync(fhirPatientId, cancellationToken: ct);

            // Call Intelligence for AI analysis
            var analysisResult = await intelligenceClient.AnalyzeAsync(clinicalBundle, paRequest.ProcedureCode, ct);

            // Map criteria from analysis â€” use human-readable label, fall back to criterion ID
            var criteria = analysisResult.SupportingEvidence.Select(e => new CriterionModel
            {
                Met = e.Status.Equals("MET", StringComparison.OrdinalIgnoreCase),
                Label = string.IsNullOrEmpty(e.CriterionLabel) ? e.CriterionId : e.CriterionLabel,
                Reason = e.Evidence,
            }).ToList();

            var confidence = (int)Math.Round(analysisResult.ConfidenceScore * 100);

            // Auto-detect primary diagnosis from FHIR conditions
            var primaryCondition = clinicalBundle.Conditions
                .FirstOrDefault(c => string.Equals(c.ClinicalStatus, "active", StringComparison.OrdinalIgnoreCase))
                ?? clinicalBundle.Conditions.FirstOrDefault();

            return await store.ApplyAnalysisResultAsync(
                id, analysisResult.ClinicalSummary, confidence, criteria,
                diagnosisCode: primaryCondition?.Code,
                diagnosisName: primaryCondition?.Display,
                ct: ct);
        }
        catch (HttpRequestException ex)
        {
            logger.LogError(ex, "External service call failed while processing PA request {PaRequestId}", id);
            throw new GraphQLException($"Failed to process PA request: external service unavailable.");
        }
    }

    public async Task<PARequestModel?> SubmitPARequest(
        string id,
        [Service] IPARequestStore store,
        CancellationToken ct,
        int addReviewTimeSeconds = 0)
    {
        return await store.SubmitAsync(id, addReviewTimeSeconds, ct);
    }

    public async Task<PARequestModel?> AddReviewTime(
        string id, int seconds,
        [Service] IPARequestStore store,
        CancellationToken ct)
    {
        return await store.AddReviewTimeAsync(id, seconds, ct);
    }

    public async Task<bool> DeletePARequest(
        string id,
        [Service] IPARequestStore store,
        CancellationToken ct)
    {
        return await store.DeleteAsync(id, ct);
    }
}
