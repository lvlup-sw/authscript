name: Project Automation

on:
  issues:
    types: [opened, labeled, unlabeled, closed, reopened]
  pull_request:
    types: [opened, ready_for_review, closed]
  push:
    branches: [main]
    paths:
      - '.github/labels.yml'
    tags:
      - 'v*'
  schedule:
    - cron: '0 9 * * 1'  # Weekly stale check, Monday 9am UTC

env:
  PROJECT_NUMBER: 1

jobs:
  # ============================================================
  # LABEL SYNC: Sync labels from labels.yml on push
  # ============================================================
  label-sync:
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install js-yaml
        run: npm install js-yaml

      - name: Sync labels
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');

            const labelsFile = '.github/labels.yml';
            if (!fs.existsSync(labelsFile)) {
              console.log(`Labels file not found: ${labelsFile}`);
              return;
            }

            const content = fs.readFileSync(labelsFile, 'utf8');
            const labelDefs = yaml.load(content);

            if (!Array.isArray(labelDefs)) {
              console.log('Labels file must contain an array of label definitions');
              return;
            }

            const { data: existingLabels } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const existingMap = new Map(existingLabels.map(l => [l.name, l]));

            for (const label of labelDefs) {
              if (!label.name) continue;

              const existing = existingMap.get(label.name);
              const color = (label.color || '').replace('#', '');
              const description = label.description || '';

              if (existing) {
                const needsUpdate =
                  existing.color.toLowerCase() !== color.toLowerCase() ||
                  (existing.description || '') !== description;

                if (needsUpdate) {
                  console.log(`Updating: ${label.name}`);
                  await github.rest.issues.updateLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: color,
                    description: description
                  });
                } else {
                  console.log(`Unchanged: ${label.name}`);
                }
              } else {
                console.log(`Creating: ${label.name}`);
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: color,
                  description: description
                });
              }
            }

            console.log('Label sync complete');

  # ============================================================
  # AUTO-TRIAGE: Label new issues based on content
  # ============================================================
  auto-triage:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Auto-label based on content
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const text = `${issue.title} ${issue.body}`.toLowerCase();
            const labels = ['status:triage'];

            // Type detection
            if (text.match(/bug|error|fail|broken|crash|issue/)) {
              labels.push('type:bug');
            } else if (text.match(/feature|add|implement|support|enhance/)) {
              labels.push('type:feature');
            } else if (text.match(/doc|readme|typo|clarif/)) {
              labels.push('type:docs');
            } else if (text.match(/\?|how|what|why|question/)) {
              labels.push('type:question');
            }

            // Scope detection
            if (text.match(/dashboard|frontend|react|vite|component|ui/)) labels.push('scope:dashboard');
            if (text.match(/gateway|backend|api|\.net|dotnet/)) labels.push('scope:gateway');
            if (text.match(/intelligence|python|ai|ml|langchain|llm|openai/)) labels.push('scope:intelligence');
            if (text.match(/fhir|hl7|epic|cerner|health/)) labels.push('scope:fhir');
            if (text.match(/pdf|document|parse|extract/)) labels.push('scope:pdf');
            if (text.match(/llm|gpt|claude|model|embedding|vector/)) labels.push('scope:llm');

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });

  # ============================================================
  # AUTO-ASSIGN: Assign PR author as assignee
  # ============================================================
  auto-assign-author:
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'opened' &&
      github.event.pull_request.user.type != 'Bot' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Assign PR author
        run: gh pr edit "$PR_URL" --add-assignee "$AUTHOR"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # STALE MANAGEMENT: Mark and close inactive issues
  # ============================================================
  stale:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/stale@v9
        with:
          stale-issue-message: |
            This issue has been automatically marked as stale because it has not had
            recent activity. It will be closed in 14 days if no further activity occurs.
          close-issue-message: |
            This issue was closed because it has been stale for 14 days with no activity.
            Feel free to reopen if this is still relevant.
          stale-issue-label: 'status:stale'
          exempt-issue-labels: 'priority:high,status:blocked'
          days-before-stale: 60
          days-before-close: 14
          operations-per-run: 30

  # ============================================================
  # PR AUTOMATION: Auto-merge Renovate PRs
  # ============================================================
  auto-merge-renovate:
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      github.event.pull_request.user.login == 'renovate[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge for Renovate PRs
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # RELEASE AUTOMATION: Generate changelog and release
  # ============================================================
  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v3
        with:
          config: .github/cliff.toml
          args: --latest --strip header

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.content }}
          generate_release_notes: false
