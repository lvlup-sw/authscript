# Implementation Plan: Investor Demo Flow — "Maria's Story"

**Feature ID:** `demo-flow`
**Design:** `docs/designs/2026-02-24-demo-flow.md`
**Date:** 2026-02-24

---

## Phase 1: Core Demo Flow

### Task 1: Intelligence Demo Mode
**Phase:** RED → GREEN → REFACTOR

1. **[RED]** Write test: `test_analyze_demo_flag_returns_canned_response`
   - File: `apps/intelligence/src/tests/test_analyze.py`
   - Send a request to `/analyze?demo=true` with procedure code `72148` (MRI Lumbar)
   - Assert response has:
     - `confidence_score >= 85`
     - All criteria `met == True`
     - Non-empty `clinical_summary`
     - `recommendation == "APPROVE"`
   - Expected failure: demo flag not recognized, returns normal (possibly low-confidence) response

2. **[RED]** Write test: `test_analyze_demo_flag_ignored_for_non_demo_procedure`
   - File: `apps/intelligence/src/tests/test_analyze.py`
   - Send `?demo=true` with a different procedure code
   - Assert normal processing occurs (demo mode only activates for the demo scenario)
   - Expected failure: no demo mode logic exists

3. **[GREEN]** Implement demo mode in analyze endpoint
   - File: `apps/intelligence/src/api/analyze.py`
   - Check for `demo=true` query parameter
   - If demo flag + procedure code matches `72148`, return a canned `PAFormResponse` with:
     - 5 criteria all met (matching MRI Lumbar LCD requirements)
     - 88% confidence
     - Clinical summary describing chronic back pain with failed conservative therapy
     - Recommendation: APPROVE
   - Otherwise, proceed with normal analysis pipeline

4. **[GREEN]** Create demo response fixture
   - File: `apps/intelligence/src/fixtures/demo_mri_lumbar.json`
   - Structured `PAFormResponse` with realistic MRI Lumbar Spine PA data

5. **[REFACTOR]** Extract demo response loading into a helper function

**Dependencies:** None
**Parallelizable:** Yes

---

### Task 2: NewPAModal Quick-Select Support
**Phase:** RED → GREEN → REFACTOR

1. **[RED]** Write test: `NewPAModal_InitialPatientAndService_StartsAtConfirmStep`
   - File: `apps/dashboard/src/components/__tests__/NewPAModal.test.tsx`
   - Render `<NewPAModal isOpen={true} initialPatient={mockPatient} initialService={mockService} />`
   - Assert: confirm step is visible (patient name and procedure name displayed)
   - Assert: patient selection step is NOT visible
   - Assert: service selection step is NOT visible
   - Expected failure: `initialPatient`/`initialService` props don't exist

2. **[RED]** Write test: `NewPAModal_NoInitialData_StartsAtPatientStep`
   - File: `apps/dashboard/src/components/__tests__/NewPAModal.test.tsx`
   - Render `<NewPAModal isOpen={true} />`
   - Assert: patient search input is visible
   - Assert: confirm step is NOT visible
   - Expected failure: should already pass (existing behavior), serves as regression guard

3. **[GREEN]** Add optional props to NewPAModal
   - File: `apps/dashboard/src/components/NewPAModal.tsx`
   - Add props: `initialPatient?: Patient`, `initialService?: { code: string; name: string; type: 'procedure' | 'medication' }`
   - If both provided, set initial step to `'confirm'` and populate `selectedPatient`/`selectedService` state
   - If not provided, start at `'patient'` step (existing behavior)

4. **[REFACTOR]** Extract demo patient/service constants
   - File: `apps/dashboard/src/lib/demoData.ts`
   - Export `DEMO_PATIENT` (Rebecca Sandbox-Test, 60182, UHC) and `DEMO_SERVICE` (MRI Lumbar, 72148)
   - These constants are reused by the dashboard auto-open (Task 4) and EHR stub (Phase 2)

**Dependencies:** None
**Parallelizable:** Yes

---

### Task 3: Dashboard Demo Mode Auto-Open
**Phase:** RED → GREEN → REFACTOR

1. **[RED]** Write test: `DashboardPage_QuickDemoParam_AutoOpensModalWithPrefill`
   - File: `apps/dashboard/src/routes/__tests__/index.test.tsx`
   - Render dashboard page with URL search param `?quickDemo=true`
   - Assert: NewPAModal is open
   - Assert: Modal shows confirm step with demo patient name and MRI Lumbar procedure
   - Expected failure: URL param not read, modal doesn't auto-open

2. **[RED]** Write test: `DashboardPage_NoParam_DoesNotAutoOpenModal`
   - File: `apps/dashboard/src/routes/__tests__/index.test.tsx`
   - Render dashboard page with no URL params
   - Assert: NewPAModal is not rendered / not open
   - Expected failure: should already pass (existing behavior)

3. **[GREEN]** Add URL param detection to dashboard page
   - File: `apps/dashboard/src/routes/index.tsx`
   - Use `useSearch()` from TanStack Router to read `quickDemo` param
   - If `quickDemo=true`, auto-open NewPAModal with `DEMO_PATIENT` and `DEMO_SERVICE` from `demoData.ts`
   - Clear the URL param after opening (prevent re-trigger on refresh)

4. **[REFACTOR]** Clean up — ensure the auto-open doesn't interfere with normal modal open/close

**Dependencies:** Task 2 (needs NewPAModal quick-select props)
**Parallelizable:** No (sequential after Task 2)

---

## Phase 2: EHR Stub

### Task 4: EHR Shell Components
**Phase:** RED → GREEN → REFACTOR

1. **[RED]** Write test: `EhrHeader_Render_ShowsAthenaNavAndPatientBanner`
   - File: `apps/dashboard/src/components/ehr/__tests__/EhrHeader.test.tsx`
   - Render `<EhrHeader patient={mockPatient} />`
   - Assert: "athenaOne" text visible
   - Assert: Patient name, DOB, MRN displayed
   - Assert: Nav items (Charts, Schedule, Messages) visible
   - Expected failure: component doesn't exist

2. **[GREEN]** Implement EhrHeader
   - File: `apps/dashboard/src/components/ehr/EhrHeader.tsx`
   - Blue header bar with "athenaOne" branding
   - Navigation tabs (non-functional, visual only)
   - Patient banner below nav: name, DOB, MRN in athena-like layout
   - Accept `patient` prop with name, dob, mrn fields

3. **[RED]** Write test: `EncounterNote_Render_ShowsClinicalSections`
   - File: `apps/dashboard/src/components/ehr/__tests__/EncounterNote.test.tsx`
   - Render `<EncounterNote encounter={mockEncounter} />`
   - Assert: Chief Complaint section visible
   - Assert: HPI section visible
   - Assert: Assessment section visible
   - Assert: Plan section with "MRI lumbar spine" visible
   - Expected failure: component doesn't exist

4. **[GREEN]** Implement EncounterNote
   - File: `apps/dashboard/src/components/ehr/EncounterNote.tsx`
   - Card-based sections: CC, HPI, Assessment & Plan
   - Hardcoded encounter data for Maria's MRI lumbar story
   - Styled to approximate athenaOne encounter card layout

5. **[REFACTOR]** Extract shared EHR styling (colors, typography) into `ehr/styles.ts`

**Dependencies:** None
**Parallelizable:** Yes

---

### Task 5: Sign Encounter Button
**Phase:** RED → GREEN → REFACTOR

1. **[RED]** Write test: `SignEncounterButton_Click_ShowsSignedStateAndCallsOnSign`
   - File: `apps/dashboard/src/components/ehr/__tests__/SignEncounterButton.test.tsx`
   - Render `<SignEncounterButton onSign={mockFn} />`
   - Click the button
   - Assert: `mockFn` was called once
   - Assert: Button text changes to "Encounter Signed" (disabled state)
   - Expected failure: component doesn't exist

2. **[RED]** Write test: `SignEncounterButton_AlreadySigned_DisabledWithCheckmark`
   - File: `apps/dashboard/src/components/ehr/__tests__/SignEncounterButton.test.tsx`
   - Render `<SignEncounterButton onSign={mockFn} signed={true} />`
   - Assert: Button is disabled
   - Assert: Shows checkmark icon
   - Expected failure: component doesn't exist

3. **[GREEN]** Implement SignEncounterButton
   - File: `apps/dashboard/src/components/ehr/SignEncounterButton.tsx`
   - Props: `onSign: () => void`, `signed?: boolean`
   - Green "Sign Encounter" button with signature icon
   - On click: calls `onSign`, transitions to signed state
   - Signed state: disabled, checkmark icon, "Encounter Signed" text

4. **[REFACTOR]** Add subtle animation on sign (checkmark appears with scale transition)

**Dependencies:** None
**Parallelizable:** Yes (with Task 4)

---

### Task 6: Embedded App Frame
**Phase:** RED → GREEN → REFACTOR

1. **[RED]** Write test: `EmbeddedAppFrame_Render_ShowsIframeWithCorrectSrc`
   - File: `apps/dashboard/src/components/ehr/__tests__/EmbeddedAppFrame.test.tsx`
   - Render `<EmbeddedAppFrame src="/" />`
   - Assert: iframe element exists
   - Assert: iframe `src` attribute equals `/`
   - Assert: iframe has `title` attribute for accessibility
   - Expected failure: component doesn't exist

2. **[RED]** Write test: `EmbeddedAppFrame_Hidden_NotVisible`
   - File: `apps/dashboard/src/components/ehr/__tests__/EmbeddedAppFrame.test.tsx`
   - Render `<EmbeddedAppFrame src="/" visible={false} />`
   - Assert: iframe wrapper has hidden/collapsed styling
   - Expected failure: component doesn't exist

3. **[GREEN]** Implement EmbeddedAppFrame
   - File: `apps/dashboard/src/components/ehr/EmbeddedAppFrame.tsx`
   - Props: `src: string`, `visible?: boolean`, `title?: string`
   - Renders iframe with sandbox attributes matching athena spec: `allow-forms allow-modals allow-scripts allow-same-origin allow-popups allow-downloads`
   - Section header: "AuthScript — Prior Authorization" with app icon
   - Collapsible: `visible` prop controls height (0 → full height transition)

4. **[REFACTOR]** Clean up — extract sandbox attribute constant

**Dependencies:** None
**Parallelizable:** Yes (with Tasks 4, 5)

---

### Task 7: EHR Demo Page Route
**Phase:** RED → GREEN → REFACTOR

1. **[RED]** Write test: `EhrDemoPage_Render_ShowsAllSections`
   - File: `apps/dashboard/src/routes/__tests__/ehr-demo.test.tsx`
   - Render the EHR demo page
   - Assert: EhrHeader visible with patient info
   - Assert: EncounterNote visible with clinical sections
   - Assert: SignEncounterButton visible
   - Assert: EmbeddedAppFrame present (initially hidden or collapsed)
   - Expected failure: route doesn't exist

2. **[RED]** Write test: `EhrDemoPage_SignEncounter_ShowsEmbeddedDashboard`
   - File: `apps/dashboard/src/routes/__tests__/ehr-demo.test.tsx`
   - Render page, click "Sign Encounter"
   - Assert: EmbeddedAppFrame becomes visible
   - Assert: iframe src points to `/?quickDemo=true` (triggers auto-open in dashboard)
   - Expected failure: no sign → show-iframe wiring

3. **[GREEN]** Create EHR demo route
   - File: `apps/dashboard/src/routes/ehr-demo.tsx`
   - Uses `createFileRoute('/ehr-demo')` (TanStack Router file-based routing)
   - Layout: EhrHeader at top, EncounterNote in main area, SignEncounterButton below note
   - On sign: set `signed=true`, reveal EmbeddedAppFrame with `src="/?quickDemo=true"`
   - EmbeddedAppFrame expands below the encounter note with a smooth transition

4. **[GREEN]** Add demo encounter data
   - File: `apps/dashboard/src/lib/demoData.ts` (extend from Task 2)
   - Add `DEMO_ENCOUNTER` constant with CC, HPI, Assessment, Plan text for MRI lumbar scenario
   - Add `DEMO_EHR_PATIENT` with name/DOB/MRN matching the demo patient

5. **[REFACTOR]** Polish layout — ensure the iframe height adapts to content, add loading state while iframe loads

**Dependencies:** Tasks 3, 4, 5, 6
**Parallelizable:** No (assembly task)

---

### Task 8: End-to-End Demo Validation
**Phase:** Integration testing (manual + automated)

1. **[RED]** Write test: `EhrDemo_FullFlow_SignToSubmission`
   - File: `apps/dashboard/src/routes/__tests__/ehr-demo.integration.test.tsx`
   - Render EHR demo page
   - Click "Sign Encounter"
   - Assert: Embedded dashboard iframe appears
   - Note: Full E2E validation with Intelligence API is manual; this test validates the component wiring

2. **[GREEN]** Fix any integration issues discovered during testing

3. Create demo validation checklist in `scripts/demo-checklist.md`:
   - [ ] Start Aspire orchestrator — all services healthy
   - [ ] Navigate to `/ehr-demo` — page loads in <2s
   - [ ] Click "Sign Encounter" — iframe appears with dashboard
   - [ ] Dashboard auto-opens NewPAModal at confirm step
   - [ ] Click "Request PA" — processing animation plays
   - [ ] Processing completes with ≥85% confidence
   - [ ] Click "Review PA Request" — analysis page loads
   - [ ] Criteria show all met (green checks)
   - [ ] Click a criterion — reasoning modal appears
   - [ ] Click "Confirm & Submit" — submission animation plays
   - [ ] Success modal appears — click "Back to Dashboard"
   - [ ] Total time: 60–90 seconds

**Dependencies:** All previous tasks
**Parallelizable:** No (final validation)

---

## Parallelization Map

```
Phase 1:
  ┌─ Task 1 (intelligence demo mode) ────────────┐
  │                                                │  Parallel
  └─ Task 2 (NewPAModal quick-select) ────────────┘
                    │
                    ▼
            Task 3 (dashboard auto-open)  ← depends on Task 2

Phase 2:
  ┌─ Task 4 (EHR shell components) ──────────────┐
  ├─ Task 5 (sign encounter button) ──────────────┤  All parallel
  └─ Task 6 (embedded app frame) ────────────────┘
                    │
                    ▼
            Task 7 (EHR demo route)  ← depends on Tasks 3,4,5,6
                    │
                    ▼
            Task 8 (E2E validation)  ← depends on Task 7
```

**Maximum parallelism:**
- Wave 1: Tasks 1, 2 (2 parallel agents — Python, React)
- Wave 2: Tasks 3, 4, 5, 6 (Task 3 sequential after 2; Tasks 4,5,6 parallel)
- Wave 3: Task 7 (assembly)
- Wave 4: Task 8 (validation)

---

## Branch Strategy

| Task | Branch |
|------|--------|
| Task 1 | `feature/demo-flow/intelligence-demo-mode` |
| Task 2 | `feature/demo-flow/modal-quick-select` |
| Task 3 | `feature/demo-flow/dashboard-auto-open` |
| Tasks 4–7 | `feature/demo-flow/ehr-stub` |
| Task 8 | `feature/demo-flow/validation` |

Base branch: `main`
